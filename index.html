<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amigo Secreto Confra 2025</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script type="module">
        import { createDirectus, rest, authentication, staticToken, readItems, createItem, readMe } from 'https://www.unpkg.com/@directus/sdk@13.0.0/dist/index.js';
        window.DirectusSDK = { createDirectus, rest, authentication, staticToken, readItems, createItem, readMe };
    </script>

    <style>
        :root {
            --primary: #ff0f7b;
            --secondary: #f89b29;
            --tertiary: #4200ff;
            --bg-deep: #0f0c29;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        
        body {
            background-color: var(--bg-deep);
            color: #fff;
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }

        /* FUNDO ANIMADO */
        .animated-bg {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(45deg, #4200ff, #ff0f7b, #f89b29, #00c6ff);
            background-size: 400% 400%;
            animation: gradientMove 15s ease infinite;
            z-index: -2;
        }
        .shapes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .shape {
            position: absolute; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);
            border-radius: 50%; animation: floatShape 20s infinite linear;
        }

        @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes floatShape { 0% { transform: translateY(110vh) rotate(0deg) scale(0.8); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(-10vh) rotate(360deg) scale(1.2); opacity: 0; } }

        /* CONTAINER 3D GLASS */
        .app-container {
            width: 90%; max-width: 420px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255,255,255,0.5);
            border-radius: 30px;
            padding: 40px 30px;
            box-shadow: 0 50px 70px -20px rgba(0,0,0,0.6);
            transform-style: preserve-3d;
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8) translateY(50px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* ELEMENTOS UI */
        h1 { 
            font-weight: 900; font-size: 2.2rem; margin-bottom: 5px; text-align: center; text-transform: uppercase;
            background: linear-gradient(to right, #fff, #ffcc00); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .year-badge {
            display: inline-block; background: #ff0f7b; color: white; padding: 2px 10px; border-radius: 20px;
            font-size: 0.9rem; transform: rotate(-5deg); box-shadow: 0 5px 15px rgba(255, 15, 123, 0.4); margin-bottom: 20px; font-weight: bold;
        }
        p.subtitle { color: rgba(255,255,255,0.8); text-align: center; margin-bottom: 30px; font-weight: 300; letter-spacing: 1px; }

        .input-group { margin-bottom: 15px; }
        input, textarea {
            width: 100%; background: rgba(0,0,0,0.3); border: 2px solid transparent; padding: 18px; border-radius: 16px;
            color: white; font-size: 16px; transition: 0.3s; outline: none; font-weight: 500;
        }
        input:focus, textarea:focus { background: rgba(0,0,0,0.5); border-color: var(--secondary); transform: scale(1.02); }

        button {
            width: 100%; padding: 18px; background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white; border: none; border-radius: 16px; font-weight: 700; font-size: 16px; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; margin-top: 10px;
            box-shadow: 0 10px 20px rgba(255, 15, 123, 0.3);
        }
        button:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 15px 30px rgba(255, 15, 123, 0.5); }

        /* VIEWS & TABS */
        .view { display: none; }
        .view.active { display: block; animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .nav-tabs { display: flex; gap: 8px; margin-bottom: 25px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 15px; }
        .nav-tab { flex: 1; padding: 12px 5px; text-align: center; border-radius: 10px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.3s; color: rgba(255,255,255,0.6); text-transform: uppercase; }
        .nav-tab.active { background: #fff; color: var(--bg-deep); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* REVELA√á√ÉO */
        .reveal-box {
            text-align: center; padding: 40px 20px; background: linear-gradient(135deg, rgba(66, 0, 255, 0.2), rgba(255, 15, 123, 0.2));
            border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px;
        }
        #revealed-name {
            font-size: 2.8rem; font-weight: 900; background: linear-gradient(to right, #fff, #f89b29);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: blur(15px); cursor: pointer; transition: 0.5s; user-select: none;
        }
        #revealed-name:hover { filter: blur(5px); }
        #revealed-name.revealed { filter: blur(0); text-shadow: 0 0 20px rgba(248, 155, 41, 0.8); }
        #revealed-name.locked { filter: none; opacity: 0.5; font-size: 1.5rem; cursor: default; }

        /* CHAT & CARDS */
        .chat-box { max-height: 300px; overflow-y: auto; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 15px; }
        .chat-msg { background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 15px 15px 15px 2px; margin-bottom: 10px; font-size: 0.9rem; width: fit-content; max-width: 85%; }
        .chat-msg.self { background: var(--primary); border-radius: 15px 15px 2px 15px; margin-left: auto; }
        
        .card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 12px; transition: 0.3s; border-left: 2px solid transparent; }
        .card:hover { transform: translateX(5px); border-left: 5px solid var(--secondary); background: rgba(255,255,255,0.1); }

        /* TOAST */
        #toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #fff; color: #000; padding: 15px 30px; border-radius: 50px; font-weight: 700;
            z-index: 1000; opacity: 0; transition: 0.4s;
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div class="animated-bg"></div>
    <div class="shapes" id="shapes-container"></div>
    <div id="toast">Notifica√ß√£o aqui</div>

    <div class="app-container" id="tilt-card">
        <div id="view-login" class="view active">
            <div style="text-align: center;">
                <span class="year-badge">CONFRA 2025</span>
                <h1>Amigo Secreto</h1>
            </div>
            <p class="subtitle">Acesse o grupo mais animado do ano!</p>
            
            <form id="login-form">
                <div class="input-group"><input type="email" id="email" placeholder="Seu E-mail" required></div>
                <div class="input-group"><input type="password" id="password" placeholder="Senha Secreta" required></div>
                <button type="submit">PARTIU AMIGAR üöÄ</button>
            </form>
        </div>

        <div id="view-dashboard" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 id="user-name" style="font-size: 1.2rem; font-weight: 700;">Ol√°, Baladeiro</h2>
                <button onclick="logout()" style="width: auto; padding: 8px 16px; font-size: 0.75rem; background: rgba(255,255,255,0.1); margin:0;">Sair</button>
            </div>

            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('meu-amigo')">ü§´ Quem tirei?</div>
                <div class="nav-tab" onclick="switchTab('desejos')">üéÅ Desejos</div>
                <div class="nav-tab" onclick="switchTab('chat')">üí¨ Chat Secreto</div>
            </div>

            <div id="tab-meu-amigo" class="tab-content">
                <div class="reveal-box">
                    <div class="reveal-content">
                        <p style="margin-bottom: 10px; font-weight: 500; letter-spacing: 2px; text-transform: uppercase; font-size: 0.8rem;">Sua miss√£o √© presentear:</p>
                        <h1 id="revealed-name" onclick="revealNameEffect(this)">Carregando...</h1>
                        <p id="reveal-hint" style="font-size: 0.75rem; margin-top: 15px; opacity: 0.8;">(Toque no nome para revelar)</p>
                    </div>
                </div>
            </div>

            <div id="tab-desejos" class="tab-content" style="display: none;">
                <div class="input-group"><input type="url" id="wish-link" placeholder="Link (opcional)"></div>
                <div class="input-group"><input type="text" id="wish-desc" placeholder="O que voc√™ quer? (Cor, tamanho...)"></div>
                <button onclick="addWish()">Adicionar √† Lista ‚ú®</button>
                <div id="my-wishes-list" style="margin-top: 25px; max-height: 250px; overflow-y: auto;"></div>
            </div>

            <div id="tab-chat" class="tab-content" style="display: none;">
                <div class="chat-box" id="chat-messages"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chat-input" placeholder="Mensagem an√¥nima...">
                    <button style="width: 60px; font-size: 1.2rem; padding: 0;" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURA√á√ÉO ---
        const API_URL = "https://amigosecreto-api-vbtt.onrender.com";
        const { createDirectus, rest, authentication, readItems, createItem, readMe } = window.DirectusSDK;
        const client = createDirectus(API_URL).with(authentication("json")).with(rest());
        let currentUser = null;

        // --- EFEITOS VISUAIS ---
        const shapesContainer = document.getElementById('shapes-container');
        for(let i=0; i<15; i++){
            const div = document.createElement('div');
            div.classList.add('shape');
            div.style.left = Math.random()*100+'%'; div.style.width=(Math.random()*100+20)+'px'; div.style.height=div.style.width;
            div.style.animationDuration=(Math.random()*20+10)+'s'; div.style.animationDelay=(Math.random()*5)+'s';
            shapesContainer.appendChild(div);
        }
        document.addEventListener('mousemove', (e) => {
            const card = document.getElementById('tilt-card');
            const xAxis = (window.innerWidth/2 - e.pageX)/25; const yAxis = (window.innerHeight/2 - e.pageY)/25;
            card.style.transform = `rotateY(${xAxis}deg) rotateX(${yAxis}deg)`;
        });

        // --- L√ìGICA DE NEG√ìCIO ---

        window.showToast = (msg) => {
            const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            if(tabName === 'chat') loadChat();
            if(tabName === 'desejos') loadMyWishes();
        }

        // --- LOGIN E CARREGAMENTO DE DADOS ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                await client.login(email, password);
                
                // IMPORTANTE: Busca o campo novo 'amigo_secreto_revelado'
                currentUser = await client.request(readMe({ 
                    fields: ['*', 'amigo_secreto_revelado'] 
                }));
                
                // Muda a tela
                document.getElementById('view-login').classList.remove('active');
                document.getElementById('view-dashboard').classList.add('active');
                document.getElementById('user-name').textContent = `E a√≠, ${currentUser.first_name || 'Fest√™ro'}!`;
                confetti({ particleCount: 100, spread: 100, origin: { y: 0.6 } });

                // VERIFICA SE O SORTEIO J√Å ACONTECEU
                const nameElement = document.getElementById('revealed-name');
                const hintElement = document.getElementById('reveal-hint');

                if (currentUser.amigo_secreto_revelado) {
                    // Sorteio Feito: Coloca o nome e aplica o efeito de Blur
                    nameElement.textContent = currentUser.amigo_secreto_revelado;
                    nameElement.classList.remove('locked'); // Remove trava
                    nameElement.classList.remove('revealed'); // Garante que comece borrado
                    hintElement.style.display = 'block';
                } else {
                    // Sorteio Pendente: Avisa e bloqueia
                    nameElement.textContent = "Aguardando Sorteio...";
                    nameElement.classList.add('locked');
                    hintElement.style.display = 'none';
                }

                showToast("Login realizado! üî•");

            } catch (error) {
                console.error(error);
                showToast("Ops! Login falhou. Verifique senha/email.");
            }
        });

        // REVELAR NOME (S√ì FUNCIONA SE TIVER SORTEIO)
        window.revealNameEffect = (element) => {
            // Se estiver bloqueado (Locked) ou j√° revelado, n√£o faz nada
            if(element.classList.contains('locked')) {
                showToast("Calma! O Admin ainda n√£o sorteou.");
                return;
            }
            
            if(!element.classList.contains('revealed')) {
                element.classList.add('revealed');
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#ff0f7b', '#f89b29', '#4200ff'] });
            } else {
                element.classList.remove('revealed');
            }
        }

        window.logout = async () => { await client.logout(); location.reload(); };

        // --- CHAT E DESEJOS (IGUAIS ANTES) ---
        window.loadChat = async () => {
            const box = document.getElementById('chat-messages');
            try {
                const messages = await client.request(readItems('mensagens', {
                    sort: ['date_created'], limit: 50, fields: ['texto_mensagem', 'apelido_exibido', 'remetente_id']
                }));
                box.innerHTML = '';
                messages.forEach(msg => {
                    const isMe = msg.remetente_id === currentUser.id; 
                    const div = document.createElement('div'); div.className = `chat-msg ${isMe ? 'self' : ''}`;
                    div.innerHTML = `<div style="font-size:0.7rem; opacity:0.7; margin-bottom:2px;">${msg.apelido_exibido || 'An√¥nimo'}</div>${msg.texto_mensagem}`;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            } catch (e) { box.innerHTML = '<p style="text-align:center; opacity:0.6">Chat vazio...</p>'; }
        }

        window.sendMessage = async () => {
            const input = document.getElementById('chat-input');
            if(!input.value) return;
            try {
                await client.request(createItem('mensagens', { texto_mensagem: input.value, apelido_exibido: "Duende Secreto" }));
                input.value = ''; loadChat();
            } catch (e) { showToast("Erro ao enviar."); }
        }

        window.addWish = async () => {
            const link = document.getElementById('wish-link').value; const desc = document.getElementById('wish-desc').value;
            try {
                await client.request(createItem('desejos', { link_produto: link, observacao: desc }));
                showToast("Desejo salvo!"); document.getElementById('wish-link').value=''; document.getElementById('wish-desc').value=''; loadMyWishes();
            } catch (e) { showToast("Erro ao salvar."); }
        }

        window.loadMyWishes = async () => {
             const list = document.getElementById('my-wishes-list');
             try {
                 const wishes = await client.request(readItems('desejos', { filter: { _creator: { _eq: "CURRENT_USER" } } }));
                 list.innerHTML = wishes.map(w => `<div class="card"><div style="color:var(--secondary); font-weight:bold;">üéÅ Quero:</div><div>${w.observacao||'-'}</div>${w.link_produto?`<a href="${w.link_produto}" target="_blank" style="color:#fff; text-decoration:underline; font-size:0.8rem;">Ver Link</a>`:''}</div>`).join('');
             } catch(e) { console.log(e); }
        }
    </script>
</body>
</html>
